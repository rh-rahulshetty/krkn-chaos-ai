FROM quay.io/podman/stable:v5.7.0

LABEL org.opencontainers.image.title="Krkn-AI" \
      org.opencontainers.image.description="AI-powered chaos engineering tool using genetic algorithms with krkn" \
      org.opencontainers.image.source="https://github.com/krkn-chaos/krkn-ai" \
      org.opencontainers.image.vendor="krkn-chaos" \
      org.opencontainers.image.licenses="Apache-2.0"

WORKDIR /app

# Install system dependencies including podman, python, and required tools
RUN dnf install -y \
    podman \
    python3.12 \
    python3-pip \
    python3-devel \
    gcc \
    gcc-c++ \
    make \
    cmake \
    wget \
    tar \
    git \
    && dnf clean all

# Install uv
RUN wget -qO- https://astral.sh/uv/install.sh | sh \
    && mv /root/.local/bin/uv /usr/local/bin/uv \
    && mv /root/.local/bin/uvx /usr/local/bin/uvx

# Install kubectl
ARG KUBECTL_VERSION=v1.31.4
RUN wget -q https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl \
    && mv kubectl /usr/local/bin/kubectl \
    && chmod +x /usr/local/bin/kubectl

# Install OpenShift client (oc)
ARG OC_VERSION=4.20.0
RUN wget -q https://mirror.openshift.com/pub/openshift-v4/clients/ocp/${OC_VERSION}/openshift-client-linux.tar.gz \
    && tar -xzf openshift-client-linux.tar.gz \
    && mv oc /usr/local/bin/oc \
    && chmod +x /usr/local/bin/oc \
    && rm -f openshift-client-linux.tar.gz

# Install krknctl
ARG KRKNCTL_VERSION=v0.10.15-beta
RUN wget -q https://github.com/krkn-chaos/krknctl/releases/download/${KRKNCTL_VERSION}/krknctl-${KRKNCTL_VERSION}-linux-amd64.tar.gz \
    && tar -xzf krknctl-${KRKNCTL_VERSION}-linux-amd64.tar.gz \
    && mv krknctl /usr/local/bin/krknctl \
    && chmod +x /usr/local/bin/krknctl \
    && rm -f krknctl-${KRKNCTL_VERSION}-linux-amd64.tar.gz LICENSE README.md

# Create virtual environment with uv
RUN uv venv /app/.venv --python python3.12

# Copy requirements and install Python dependencies into venv
COPY requirements.txt .
RUN uv pip install --no-cache -r requirements.txt

# Copy the project files
COPY . .

# Install krkn-ai in editable mode into venv
RUN uv pip install -e .

# Copy entrypoint script
COPY containers/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Create mount points for input/output
RUN mkdir -p /input /output

# Make /app writable for any user (needed for --userns=keep-id)
RUN chmod -R 777 /app

# Set virtual environment path
ENV VIRTUAL_ENV=/app/.venv
ENV PATH="$VIRTUAL_ENV/bin:$PATH"

# Use /tmp for UV cache to avoid permission issues with user namespace mapping
ENV UV_CACHE_DIR=/tmp/.uv-cache

# Environment variables with defaults
ENV MODE=run
ENV KUBECONFIG=/input/kubeconfig
ENV CONFIG_FILE=/input/krkn-ai.yaml
ENV OUTPUT_DIR=/output
ENV NAMESPACE=".*"
ENV POD_LABEL=".*"
ENV NODE_LABEL=".*"
ENV FORMAT=yaml
ENV RUNNER_TYPE="krknhub"
ENV VERBOSE=0
ENV SKIP_POD_NAME=""
ENV EXTRA_PARAMS=""

ENTRYPOINT ["/entrypoint.sh"]
